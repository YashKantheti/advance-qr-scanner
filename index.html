  <script>
    const { ipcRenderer } = require('electron');
    
    // DOM Elements
    const video = document.getElementById('video');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const fileInput = document.getElementById('fileInput');
    const resultContainer = document.getElementById('resultContainer');
    const noResultContainer = document.getElementById('noResultContainer');
    const riskIndicator = document.getElementById('riskIndicator');
    const riskLevel = document.getElementById('riskLevel');
    const contentType = document.getElementById('contentType');
    const qrContent = document.getElementById('qrContent');
    const analysisResult = document.getElementById('analysisResult');
    const detailsContainer = document.getElementById('detailsContainer');
    const detailsContent = document.getElementById('detailsContent');
    const reasonsContainer = document.getElementById('reasonsContainer');
    const reasonsList = document.getElementById('reasonsList');
    
    // Modal Elements
    const historyButton = document.getElementById('historyButton');
    const historyModal = document.getElementById('historyModal');
    const closeHistoryModal = document.getElementById('closeHistoryModal');
    const historyTableBody = document.getElementById('historyTableBody');
    const analysisModal = document.getElementById('analysisModal');
    const closeAnalysisModal = document.getElementById('closeAnalysisModal');
    const closeAnalysisBtn = document.getElementById('closeAnalysisBtn');
    const analysisModalContent = document.getElementById('analysisModalContent');
    const reportMaliciousBtn = document.getElementById('reportMaliciousBtn');
    
    // Variables
    let stream = null;
    let scanning = false;
    let canvasElement;
    let canvasContext;
    let currentQrContent = null;
    let currentAnalysis = null;
    
    // Initialize canvas for QR detection
    function initCanvas() {
      canvasElement = document.createElement('canvas');
      canvasContext = canvasElement.getContext('2d');
    }
    
    // Start camera and QR scanning
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        
        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        video.play();
        
        startButton.disabled = true;
        stopButton.disabled = false;
        
        scanning = true;
        requestAnimationFrame(tick);
      } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Unable to access camera. Please check permissions.');
      }
    }
    
    // Stop camera and QR scanning
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      video.srcObject = null;
      scanning = false;
      
      startButton.disabled = false;
      stopButton.disabled = true;
    }
    
    // Process video frames for QR detection
    function tick() {
      if (!scanning) return;
      
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvasContext.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        
        const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: 'dontInvert',
        });
        
        if (code) {
          // QR code detected
          handleQRCode(code.data);
          // Pause scanning briefly to prevent multiple detections
          scanning = false;
          setTimeout(() => {
            scanning = true;
            requestAnimationFrame(tick);
          }, 2000);
        } else {
          requestAnimationFrame(tick);
        }
      } else {
        requestAnimationFrame(tick);
      }
    }
    
    // Handle uploaded QR code image
    function handleFileInput(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          canvasElement.width = img.width;
          canvasElement.height = img.height;
          canvasContext.drawImage(img, 0, 0, img.width, img.height);
          
          const imageData = canvasContext.getImageData(0, 0, img.width, img.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: 'dontInvert',
          });
          
          if (code) {
            handleQRCode(code.data);
          } else {
            alert('No QR code found in the image');
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    // Process QR code content and display results
    async function handleQRCode(content) {
      console.log('QR Code detected:', content);
      currentQrContent = content;
      
      // Clear previous results
      detailsContainer.classList.add('hidden');
      reasonsContainer.classList.add('hidden');
      detailsContent.innerHTML = '';
      reasonsList.innerHTML = '';
      
      // Remove any previous action buttons
      const previousActions = resultContainer.querySelector('div:last-child');
      if (previousActions && previousActions.classList.contains('mt-6')) {
        resultContainer.removeChild(previousActions);
      }
      
      // Show loading indicator
      resultContainer.classList.remove('hidden');
      noResultContainer.classList.add('hidden');
      riskIndicator.className = 'p-4 rounded-md border mb-4 flex items-center risk-unknown';
      riskLevel.textContent = 'Analyzing...';
      contentType.textContent = 'Scanning...';
      qrContent.textContent = content;
      analysisResult.textContent = 'Performing security analysis...';
      
      // Analyze the QR code content for risks
      const analysis = await ipcRenderer.invoke('analyze-qr-content', content);
      currentAnalysis = analysis;
      
      // Save scan to history
      await ipcRenderer.invoke('save-scan', {
        content: content,
        riskLevel: analysis.riskLevel,
        type: analysis.details.type
      });
      
      // Update risk level indicator
      riskIndicator.className = `p-4 rounded-md border mb-4 flex items-center risk-${analysis.riskLevel}`;
      riskLevel.textContent = analysis.riskLevel.charAt(0).toUpperCase() + analysis.riskLevel.slice(1);
      
      // Update content type
      contentType.textContent = analysis.details.type
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
      
      // Update analysis result
      analysisResult.textContent = analysis.details.analysis || 'No additional analysis available';
      
      // Show additional details if available
      const detailsToShow = [];
      
      if (analysis.details.url) {
        detailsToShow.push(`<div class="mb-2"><strong>URL:</strong> ${analysis.details.url}</div>`);
      }
      
      if (analysis.details.domain) {
        detailsToShow.push(`<div class="mb-2"><strong>Domain:</strong> ${analysis.details.domain}</div>`);
      }
      
      if (analysis.details.network) {
        detailsToShow.push(`<div class="mb-2"><strong>Network:</strong> ${analysis.details.network}</div>`);
      }
      
      if (analysis.details.security) {
        detailsToShow.push(`<div class="mb-2"><strong>Security:</strong> ${analysis.details.security}</div>`);
      }
      
      if (analysis.details.riskScore) {
        detailsToShow.push(`<div class="mb-2"><strong>Risk Score:</strong> ${analysis.details.riskScore}</div>`);
      }
      
      if (detailsToShow.length > 0) {
        detailsContainer.classList.remove('hidden');
        detailsContent.innerHTML = detailsToShow.join('');
      }
      
      // Show reasons if available
      if (analysis.details.reasons && analysis.details.reasons.length > 0) {
        reasonsContainer.classList.remove('hidden');
        reasonsList.innerHTML = '';
        
        analysis.details.reasons.forEach(reason => {
          const li = document.createElement('li');
          li.textContent = reason;
          reasonsList.appendChild(li);
        });
      }
      
      // Add actions based on content type
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'mt-6 pt-4 border-t border-gray-200';
      actionsDiv.innerHTML = `
        <h3 class="font-medium text-gray-700 mb-2">Actions:</h3>
        <div class="flex flex-wrap gap-2">
          <button id="advancedAnalysisBtn" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
            Detailed Analysis
          </button>
      `;
      
      // Add URL-specific actions
      if (analysis.details.url) {
        actionsDiv.querySelector('.flex').innerHTML += `
          <button id="safeOpenBtn" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
            Open in Safe Mode
          </button>
          <button id="copyUrlBtn" class="px-3 py-1 bg-gray-200 text-gray-800 text-sm rounded hover:bg-gray-300">
            Copy URL
          </button>
          <button id="checkReputationBtn" class="px-3 py-1 bg-blue-200 text-blue-800 text-sm rounded hover:bg-blue-300">
            Check Reputation
          </button>
        `;
      }
      
      // Add report button for all types
      actionsDiv.querySelector('.flex').innerHTML += `
        <button id="reportQrBtn" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
          Report as Malicious
        </button>
      `;
      
      resultContainer.appendChild(actionsDiv);
      
      // Add event listeners for action buttons
      document.getElementById('advancedAnalysisBtn').addEventListener('click', showDetailedAnalysis);
      
      if (analysis.details.url) {
        document.getElementById('safeOpenBtn').addEventListener('click', () => {
          // In a real app, this would open in a sandboxed view
          showURLPreview(analysis.details.url);
        });
        
        document.getElementById('copyUrlBtn').addEventListener('click', () => {
          navigator.clipboard.writeText(analysis.details.url);
          alert('URL copied to clipboard');
        });
        
        document.getElementById('checkReputationBtn').addEventListener('click', () => {
          checkUrlReputation(analysis.details.url);
        });
      }
      
      document.getElementById('reportQrBtn').addEventListener('click', () => {
        reportMalicious(content, analysis.details.type);
      });
    }
    
    // Show detailed analysis in modal
    function showDetailedAnalysis() {
      if (!currentAnalysis) return;
      
      let modalContent = `
        <div class="mb-4">
          <div class="${getClassForRiskLevel(currentAnalysis.riskLevel)} p-3 rounded-md">
            <h4 class="font-bold text-lg mb-1">Risk Level: ${currentAnalysis.riskLevel.toUpperCase()}</h4>
            <p>${currentAnalysis.details.analysis || ''}</p>
          </div>
        </div>
        
        <div class="mb-4">
          <h4 class="font-semibold text-gray-700 mb-2">QR Content:</h4>
          <pre class="bg-gray-50 p-3 rounded overflow-x-auto">${currentQrContent}</pre>
        </div>
      `;
      
      // Add detailed analysis sections based on content type
      if (currentAnalysis.details.type === 'url' || currentAnalysis.details.type === 'suspicious_url') {
        modalContent += `
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">URL Analysis:</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p><strong>Domain:</strong> ${currentAnalysis.details.domain || 'N/A'}</p>
              <p><strong>Risk Score:</strong> ${currentAnalysis.details.riskScore || 'N/A'}</p>
              ${
                currentAnalysis.details.reasons ? 
                `<div class="mt-2">
                  <strong>Risk Factors:</strong>
                  <ul class="list-disc ml-5 mt-1">
                    ${currentAnalysis.details.reasons.map(reason => `<li>${reason}</li>`).join('')}
                  </ul>
                </div>` : ''
              }
            </div>
          </div>
          
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">Safety Recommendations:</h4>
            <ul class="list-disc ml-5">
              <li>Verify the URL is from a trusted source</li>
              <li>Check for misspellings in the domain</li>
              <li>Be cautious of shortened URLs</li>
              <li>Never enter credentials on suspicious sites</li>
            </ul>
          </div>
        `;
      } else if (currentAnalysis.details.type === 'wifi_credentials') {
        modalContent += `
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">WiFi Network Analysis:</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p><strong>Network:</strong> ${currentAnalysis.details.network || 'N/A'}</p>
              <p><strong>Security:</strong> ${currentAnalysis.details.security || 'N/A'}</p>
              ${
                currentAnalysis.details.reasons ? 
                `<div class="mt-2">
                  <strong>Risk Factors:</strong>
                  <ul class="list-disc ml-5 mt-1">
                    ${currentAnalysis.details.reasons.map(reason => `<li>${reason}</li>`).join('')}
                  </ul>
                </div>` : ''
              }
            </div>
          </div>
          
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">Safety Recommendations:</h4>
            <ul class="list-disc ml-5">
              <li>Only connect to networks from trusted sources</li>
              <li>Avoid public WiFi for sensitive activities</li>
              <li>Use a VPN when connecting to public networks</li>
              <li>Verify the network with the provider before connecting</li>
            </ul>
          </div>
        `;
      } else {
        // Generic recommendations for other types
        modalContent += `
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">Safety Recommendations:</h4>
            <ul class="list-disc ml-5">
              <li>Always verify QR codes from unknown sources</li>
              <li>Be cautious with QR codes in public places</li>
              <li>Check the content before taking action</li>
              <li>Keep your device's software updated</li>
            </ul>
          </div>
        `;
      }
      
      analysisModalContent.innerHTML = modalContent;
      analysisModal.classList.remove('hidden');
    }
    
    // Show URL preview in modal
    function showURLPreview(url) {
      analysisModalContent.innerHTML = `
        <div class="mb-4">
          <h4 class="font-semibold text-gray-700 mb-2">URL Preview:</h4>
          <p class="bg-gray-50 p-2 rounded mb-2 overflow-x-auto break-all">${url}</p>
          <p class="text-sm text-gray-500 mb-4">Showing limited information for security. Click "Open in Browser" to proceed.</p>
        </div>
        
        <div class="mb-4">
          <h4 class="font-semibold text-gray-700 mb-2">Security Status:</h4>
          <p>This URL would be checked against phishing databases and scanned for malicious content before loading.</p>
        </div>
        
        <div class="flex gap-2 mt-4">
          <button id="openInBrowserBtn" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
            Open in Browser
          </button>
        </div>
      `;
      
      analysisModal.classList.remove('hidden');
      
      // Add event listener for the open in browser button
      document.getElementById('openInBrowserBtn').addEventListener('click', () => {
        // This would normally use a more secure method
        require('electron').shell.openExternal(url);
        analysisModal.classList.add('hidden');
      });
    }
    
    // Check URL reputation
    async function checkUrlReputation(url) {
      analysisModalContent.innerHTML = `
        <div class="flex justify-center items-center h-40">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
      `;
      
      analysisModal.classList.remove('hidden');
      
      try {
        const reputation = await ipcRenderer.invoke('check-url-reputation', url);
        
        let statusClass;
        let statusIcon;
        
        switch (reputation.reputation) {
          case 'safe':
            statusClass = 'bg-green-100 text-green-800';
            statusIcon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>`;
            break;
          case 'malicious':
            statusClass = 'bg-red-100 text-red-800';
            statusIcon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>`;
            break;
          case 'suspicious':
            statusClass = 'bg-yellow-100 text-yellow-800';
            statusIcon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>`;
            break;
          default:
            statusClass = 'bg-gray-100 text-gray-800';
            statusIcon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>`;
        }
        
        analysisModalContent.innerHTML = `
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">URL Reputation:</h4>
            <div class="${statusClass} p-3 rounded-md flex items-center">
              ${statusIcon}
              <div>
                <p class="font-semibold">${capitalizeFirstLetter(reputation.reputation)}</p>
                <p class="text-sm">Reputation Score: ${reputation.score || 'N/A'}</p>
              </div>
            </div>
          </div>
          
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">Domain Information:</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p><strong>Domain:</strong> ${reputation.domain || url}</p>
              ${reputation.categories ? `<p><strong>Categories:</strong> ${reputation.categories.join(', ')}</p>` : ''}
            </div>
          </div>
          
          <div class="mb-4">
            <p class="text-sm text-gray-500">
              <strong>Note:</strong> This reputation check simulates what a real security service would provide. In a production app, 
              this would use services like Google Safe Browsing, VirusTotal, or other URL reputation APIs.
            </p>
          </div>
        `;
      } catch (error) {
        analysisModalContent.innerHTML = `
          <div class="p-3 bg-red-100 text-red-800 rounded-md">
            <p>Error checking URL reputation: ${error.message || 'Unknown error'}</p>
          </div>
        `;
      }
    }
    
    // Report QR code as malicious
    async function reportMalicious(content, contentType) {
      if (!content) return;
      
      analysisModalContent.innerHTML = `
        <div class="mb-4">
          <h4 class="font-semibold text-gray-700 mb-2">Report Malicious QR Code</h4>
          <p class="mb-4">Help improve security by reporting this QR code as malicious.</p>
          
          <div class="mb-4">
            <label for="reportReason" class="block text-sm font-medium text-gray-700 mb-1">Reason for reporting:</label>
            <select id="reportReason" class="w-full p-2 border border-gray-300 rounded">
              <option value="phishing">Phishing attempt</option>
              <option value="malware">Contains malware</option>
              <option value="scam">Scam or fraud</option>
              <option value="inappropriate">Inappropriate content</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label for="reportDetails" class="block text-sm font-medium text-gray-700 mb-1">Additional details (optional):</label>
            <textarea id="reportDetails" class="w-full p-2 border border-gray-300 rounded h-24"></textarea>
          </div>
        </div>
      `;
      
      analysisModal.classList.remove('hidden');
      
      // Change button text for reporting
      reportMaliciousBtn.textContent = 'Submit Report';
      reportMaliciousBtn.onclick = async () => {
        const reason = document.getElementById('reportReason').value;
        const details = document.getElementById('reportDetails').value;
        
        // Add to known threats database
        try {
          await ipcRenderer.invoke('save-threat', {
            content: content,
            type: contentType,
            reason: `${reason}${details ? ': ' + details : ''}`
          });
          
          analysisModalContent.innerHTML = `
            <div class="p-4 bg-green-100 text-green-800 rounded-md">
              <p class="font-semibold">Thank you for your report!</p>
              <p class="mt-2">This QR code has been added to the known threats database. Future scans will identify it as malicious.</p>
            </div>
          `;
          
          // Reset button
          reportMaliciousBtn.textContent = 'Report as Malicious';
          reportMaliciousBtn.onclick = null;
        } catch (error) {
          analysisModalContent.innerHTML = `
            <div class="p-4 bg-red-100 text-red-800 rounded-md">
              <p>Error saving report: ${error.message || 'Unknown error'}</p>
            </div>
          `;
        }
      };
    }
    
    // Load scan history
    async function loadScanHistory() {
      historyTableBody.innerHTML = '';
      
      const history = await ipcRenderer.invoke('get-scan-history');
      
      if (history.length === 0) {
        historyTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
              No scan history found
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort history by timestamp (newest first)
      history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      history.forEach(scan => {
        const row = document.createElement('tr');
        
        // Format date
        const date = new Date(scan.timestamp);
        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        
        // Truncate content if too long
        const truncatedContent = scan.content.length > 30 
          ? scan.content.substring(0, 30) + '...' 
          : scan.content;
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${formattedDate}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${formatContentType(scan.type)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getRiskLevelClass(scan.riskLevel)}">
              ${capitalizeFirstLetter(scan.riskLevel)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate">
            ${truncatedContent}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button class="text-indigo-600 hover:text-indigo-900 rescan-btn" data-content="${escapeHtml(scan.content)}">
              Rescan
            </button>
          </td>
        `;
        
        historyTableBody.appendChild(row);
      });
      
      // Add event listeners to rescan buttons
      document.querySelectorAll('.rescan-btn').forEach(button => {
        button.addEventListener('click', () => {
          const content = button.getAttribute('data-content');
          if (content) {
            handleQRCode(content);
            historyModal.classList.add('hidden');
          }
        });
      });
    }
    
    // Helper functions
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    function formatContentType(type) {
      return type
        .split('_')
        .map(word => capitalizeFirstLetter(word))
        .join(' ');
    }
    
    function getRiskLevelClass(level) {
      switch (level) {
        case 'high':
          return 'bg-red-100 text-red-800';
        case 'medium':
          return 'bg-yellow-100 text-yellow-800';
        case 'low':
          return 'bg-green-100 text-green-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }
    
    function getClassForRiskLevel(level) {
      switch (level) {
        case 'high':
          return 'bg-red-100 text-red-800 border border-red-200';
        case 'medium':
          return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
        case 'low':
          return 'bg-green-100 text-green-800 border border-green-200';
        default:
          return 'bg-gray-100 text-gray-800 border border-gray-200';
      }
    }
    
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    // Event listeners
    window.addEventListener('DOMContentLoaded', initCanvas);
    startButton.addEventListener('click', startCamera);
    stopButton.addEventListener('click', stopCamera);
    fileInput.addEventListener('change', handleFileInput);
    
    // Modal event listeners
    historyButton.addEventListener('click', () => {
      loadScanHistory();
      historyModal.classList.remove('hidden');
    });
    
    closeHistoryModal.addEventListener('click', () => {
      historyModal.classList.add('hidden');
    });
    
    closeAnalysisModal.addEventListener('click', () => {
      analysisModal.classList.add('hidden');
    });
    
    closeAnalysisBtn.addEventListener('click', () => {
      analysisModal.classList.add('hidden');
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
      if (event.target === historyModal) {
        historyModal.classList.add('hidden');
      }
      
      if (event.target === analysisModal) {
        analysisModal.classList.add('hidden');
      }
    });
  </script><!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QR Code Risk Scanner</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <style>
    .camera-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      height: 375px;
      overflow: hidden;
      border-radius: 8px;
    }
    
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .scan-region-highlight {
      border: 2px solid #00ff00;
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200px;
      height: 200px;
      transform: translate(-50%, -50%);
      z-index: 1;
    }
    
    .risk-high {
      background-color: #fee2e2;
      border-color: #ef4444;
      color: #b91c1c;
    }
    
    .risk-medium {
      background-color: #fef3c7;
      border-color: #f59e0b;
      color: #b45309;
    }
    
    .risk-low {
      background-color: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }
    
    .risk-unknown {
      background-color: #e5e7eb;
      border-color: #6b7280;
      color: #374151;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto p-4">
    <header class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">QR Code Risk Scanner</h1>
        <p class="text-gray-600">Scan QR codes and assess potential security risks</p>
      </div>
      <div>
        <button id="historyButton" class="px-4 py-2 bg-gray-100 text-gray-800 rounded hover:bg-gray-200 focus:outline-none flex items-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Scan History
        </button>
      </div>
    </header>
    
    <div class="flex flex-col md:flex-row gap-6">
      <div class="bg-white p-6 rounded-lg shadow-md flex-1">
        <h2 class="text-xl font-semibold mb-4">Scanner</h2>
        
        <div class="camera-container mx-auto mb-4">
          <video id="video" playsinline></video>
          <div class="scan-region-highlight"></div>
        </div>
        
        <div class="flex justify-center space-x-4 mb-4">
          <button id="startButton" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none">
            Start Camera
          </button>
          <button id="stopButton" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 focus:outline-none" disabled>
            Stop Camera
          </button>
        </div>
        
        <div class="mt-4">
          <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">Or upload QR code image:</label>
          <input type="file" id="fileInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        </div>
      </div>
      
      <div class="bg-white p-6 rounded-lg shadow-md flex-1">
        <h2 class="text-xl font-semibold mb-4">Analysis Results</h2>
        
        <div id="resultContainer" class="hidden">
          <div id="riskIndicator" class="p-4 rounded-md border mb-4 flex items-center">
            <svg id="riskIcon" class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <p class="font-medium">Risk Level: <span id="riskLevel">Unknown</span></p>
            </div>
          </div>
          
          <div class="mb-4">
            <h3 class="font-medium text-gray-700 mb-1">QR Content Type:</h3>
            <p id="contentType" class="text-gray-800">-</p>
          </div>
          
          <div class="mb-4">
            <h3 class="font-medium text-gray-700 mb-1">Content:</h3>
            <p id="qrContent" class="text-gray-800 break-all bg-gray-50 p-3 rounded">-</p>
          </div>
          
          <div id="detailsContainer" class="mb-4 hidden">
            <h3 class="font-medium text-gray-700 mb-1">Details:</h3>
            <div id="detailsContent" class="text-gray-800"></div>
          </div>
          
          <div>
            <h3 class="font-medium text-gray-700 mb-1">Analysis:</h3>
            <p id="analysisResult" class="text-gray-800">-</p>
          </div>
          
          <div id="reasonsContainer" class="mt-4 hidden">
            <h3 class="font-medium text-gray-700 mb-1">Risk Factors:</h3>
            <ul id="reasonsList" class="list-disc pl-5 text-gray-800"></ul>
          </div>
        </div>
        
        <div id="noResultContainer" class="flex flex-col items-center justify-center h-64 text-gray-400">
          <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          <p class="text-center">Scan a QR code to see analysis results</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- History Modal -->
  <div id="historyModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity" aria-hidden="true">
        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
      </div>
      
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900">
              Scan History
            </h3>
            <button type="button" id="closeHistoryModal" class="text-gray-400 hover:text-gray-500">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <div class="overflow-auto max-h-96">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Timestamp
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Type
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Risk Level
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Content
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                <!-- History items will be inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Detailed Analysis Modal -->
  <div id="analysisModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity" aria-hidden="true">
        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
      </div>
      
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900">
              Detailed Analysis
            </h3>
            <button type="button" id="closeAnalysisModal" class="text-gray-400 hover:text-gray-500">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <div id="analysisModalContent">
            <!-- Analysis results will go here -->
          </div>
        </div>
        
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" id="reportMaliciousBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
            Report as Malicious
          </button>
          <button type="button" id="closeAnalysisBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const { ipcRenderer } = require('electron');
    
    // DOM Elements
    const video = document.getElementById('video');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const fileInput = document.getElementById('fileInput');
    const resultContainer = document.getElementById('resultContainer');
    const noResultContainer = document.getElementById('noResultContainer');
    const riskIndicator = document.getElementById('riskIndicator');
    const riskLevel = document.getElementById('riskLevel');
    const contentType = document.getElementById('contentType');
    const qrContent = document.getElementById('qrContent');
    const analysisResult = document.getElementById('analysisResult');
    const detailsContainer = document.getElementById('detailsContainer');
    const detailsContent = document.getElementById('detailsContent');
    const reasonsContainer = document.getElementById('reasonsContainer');
    const reasonsList = document.getElementById('reasonsList');
    
    // Variables
    let stream = null;
    let scanning = false;
    let canvasElement;
    let canvasContext;
    
    // Initialize canvas for QR detection
    function initCanvas() {
      canvasElement = document.createElement('canvas');
      canvasContext = canvasElement.getContext('2d');
    }
    
    // Start camera and QR scanning
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        
        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        video.play();
        
        startButton.disabled = true;
        stopButton.disabled = false;
        
        scanning = true;
        requestAnimationFrame(tick);
      } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Unable to access camera. Please check permissions.');
      }
    }
    
    // Stop camera and QR scanning
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      video.srcObject = null;
      scanning = false;
      
      startButton.disabled = false;
      stopButton.disabled = true;
    }
    
    // Process video frames for QR detection
    function tick() {
      if (!scanning) return;
      
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvasContext.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        
        const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: 'dontInvert',
        });
        
        if (code) {
          // QR code detected
          handleQRCode(code.data);
          // Pause scanning briefly to prevent multiple detections
          scanning = false;
          setTimeout(() => {
            scanning = true;
            requestAnimationFrame(tick);
          }, 2000);
        } else {
          requestAnimationFrame(tick);
        }
      } else {
        requestAnimationFrame(tick);
      }
    }
    
    // Handle uploaded QR code image
    function handleFileInput(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          canvasElement.width = img.width;
          canvasElement.height = img.height;
          canvasContext.drawImage(img, 0, 0, img.width, img.height);
          
          const imageData = canvasContext.getImageData(0, 0, img.width, img.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: 'dontInvert',
          });
          
          if (code) {
            handleQRCode(code.data);
          } else {
            alert('No QR code found in the image');
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    // Process QR code content and display results
    async function handleQRCode(content) {
      console.log('QR Code detected:', content);
      
      // Clear previous results
      detailsContainer.classList.add('hidden');
      reasonsContainer.classList.add('hidden');
      detailsContent.innerHTML = '';
      reasonsList.innerHTML = '';
      
      // Show loading indicator
      resultContainer.classList.remove('hidden');
      noResultContainer.classList.add('hidden');
      riskIndicator.className = 'p-4 rounded-md border mb-4 flex items-center risk-unknown';
      riskLevel.textContent = 'Analyzing...';
      contentType.textContent = 'Scanning...';
      qrContent.textContent = content;
      analysisResult.textContent = 'Performing security analysis...';
      
      // Analyze the QR code content for risks
      const analysis = await ipcRenderer.invoke('analyze-qr-content', content);
      
      // Update risk level indicator
      riskIndicator.className = `p-4 rounded-md border mb-4 flex items-center risk-${analysis.riskLevel}`;
      riskLevel.textContent = analysis.riskLevel.charAt(0).toUpperCase() + analysis.riskLevel.slice(1);
      
      // Update content type
      contentType.textContent = analysis.details.type
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
      
      // Update analysis result
      analysisResult.textContent = analysis.details.analysis || 'No additional analysis available';
      
      // Show additional details if available
      const detailsToShow = [];
      
      if (analysis.details.url) {
        detailsToShow.push(`<div class="mb-2"><strong>URL:</strong> ${analysis.details.url}</div>`);
      }
      
      if (analysis.details.domain) {
        detailsToShow.push(`<div class="mb-2"><strong>Domain:</strong> ${analysis.details.domain}</div>`);
      }
      
      if (analysis.details.network) {
        detailsToShow.push(`<div class="mb-2"><strong>Network:</strong> ${analysis.details.network}</div>`);
      }
      
      if (analysis.details.security) {
        detailsToShow.push(`<div class="mb-2"><strong>Security:</strong> ${analysis.details.security}</div>`);
      }
      
      if (analysis.details.riskScore) {
        detailsToShow.push(`<div class="mb-2"><strong>Risk Score:</strong> ${analysis.details.riskScore}</div>`);
      }
      
      if (detailsToShow.length > 0) {
        detailsContainer.classList.remove('hidden');
        detailsContent.innerHTML = detailsToShow.join('');
      }
      
      // Show reasons if available
      if (analysis.details.reasons && analysis.details.reasons.length > 0) {
        reasonsContainer.classList.remove('hidden');
        reasonsList.innerHTML = '';
        
        analysis.details.reasons.forEach(reason => {
          const li = document.createElement('li');
          li.textContent = reason;
          reasonsList.appendChild(li);
        });
      }
      
      // Add actions based on content type
      if (analysis.details.url) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'mt-6 pt-4 border-t border-gray-200';
        actionsDiv.innerHTML = `
          <h3 class="font-medium text-gray-700 mb-2">Actions:</h3>
          <div class="flex space-x-2">
            <button id="safeOpenBtn" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
              Open in Safe Mode
            </button>
            <button id="copyUrlBtn" class="px-3 py-1 bg-gray-200 text-gray-800 text-sm rounded hover:bg-gray-300">
              Copy URL
            </button>
          </div>
        `;
        
        resultContainer.appendChild(actionsDiv);
        
        // Add event listeners for action buttons
        document.getElementById('safeOpenBtn').addEventListener('click', () => {
          // In a real app, this would open in a sandboxed view
          alert('This would open the URL in a safe, sandboxed view');
        });
        
        document.getElementById('copyUrlBtn').addEventListener('click', () => {
          navigator.clipboard.writeText(analysis.details.url);
          alert('URL copied to clipboard');
        });
      }
    }
    
    // Event listeners
    window.addEventListener('DOMContentLoaded', initCanvas);
    startButton.addEventListener('click', startCamera);
    stopButton.addEventListener('click', stopCamera);
    fileInput.addEventListener('change', handleFileInput);
  </script>
</body>
</html>
